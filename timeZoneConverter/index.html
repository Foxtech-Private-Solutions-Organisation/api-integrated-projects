<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Earthquake & Natural Disaster Monitor</title>

  <!-- Leaflet CSS (fixed, no integrity) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --bg: #f6f8fb;
      --panel: #ffffff;
      --text: #111827;
      --muted:#6b7280;
      --accent: #e75b1e;
    }
    [data-theme="dark"]{
      --bg:#0b1220; --panel:#0f1724; --text:#e6eef8; --muted:#9aa6b2; --accent:#ff7a3b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      height:100vh;
      display:flex;
      flex-direction:column;
    }
    header{
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px 16px;
      border-bottom:1px solid rgba(0,0,0,0.1);
    }
    header h1{margin:0;font-size:18px}
    .controls{margin-left:auto;display:flex;gap:8px}
    .btn{padding:6px 10px;border-radius:6px;border:0;background:var(--accent);color:white;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--text);border:1px solid rgba(0,0,0,0.2)}
    .container{display:flex;flex:1;min-height:0}
    .sidebar{
      width:300px;
      background:var(--panel);
      padding:14px;
      overflow:auto;
      border-right:1px solid rgba(0,0,0,0.1);
    }
    label{font-size:12px;color:var(--muted)}
    #eventsList{list-style:none;padding:0;margin:10px 0 0 0}
    #eventsList li{
      padding:8px;border-radius:6px;margin-bottom:6px;background:rgba(0,0,0,0.02);
      cursor:pointer;border:1px solid rgba(0,0,0,0.05)
    }
    #map{flex:1}
    footer{font-size:12px;color:var(--muted);margin-top:10px}
  </style>
</head>
<body data-theme="light">

  <header>
    <h1>üåç Earthquake & Natural Disaster Monitor</h1>
    <div class="controls">
      <button id="themeToggle" class="btn ghost">Dark</button>
      <button id="reloadBtn" class="btn">Reload</button>
    </div>
  </header>

  <div class="container">
    <aside class="sidebar">
      <div>
        <label for="timeframe">Earthquake timeframe</label><br>
        <select id="timeframe">
          <option value="hour">Past Hour</option>
          <option value="day" selected>Past Day</option>
          <option value="week">Past 7 Days</option>
          <option value="month">Past 30 Days</option>
        </select>
      </div>
      <div>
        <label for="minmag">Minimum magnitude</label><br>
        <input id="minmag" type="number" value="2.5" step="0.1">
      </div>
      <div>
        <label>Events List</label>
        <ul id="eventsList"></ul>
      </div>
      <footer>
        Data: <b>USGS</b> & <b>NASA EONET</b><br>Map: OpenStreetMap
      </footer>
    </aside>

    <main id="map"></main>
  </div>

  <!-- Leaflet JS (fixed, no integrity) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    const map = L.map('map').setView([20,0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    const quakesLayer = L.layerGroup().addTo(map);
    const eventsLayer = L.layerGroup().addTo(map);

    const eventsList = document.getElementById('eventsList');
    const timeframeEl = document.getElementById('timeframe');
    const minmagEl = document.getElementById('minmag');
    const reloadBtn = document.getElementById('reloadBtn');
    const themeToggle = document.getElementById('themeToggle');
    const body = document.body;

    async function loadData(){
      quakesLayer.clearLayers();
      eventsLayer.clearLayers();
      eventsList.innerHTML = "Loading...";

      try{
        const feedMap = {
          hour: 'all_hour.geojson',
          day: 'all_day.geojson',
          week: 'all_week.geojson',
          month: 'all_month.geojson'
        };
        const feed = feedMap[timeframeEl.value];
        const minmag = parseFloat(minmagEl.value)||0;

        const usgsUrl = `https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/${feed}`;
        const eonetUrl = `https://eonet.gsfc.nasa.gov/api/v3/events?status=open`;

        const [usgsRes, eonetRes] = await Promise.all([fetch(usgsUrl), fetch(eonetUrl)]);
        const usgsData = await usgsRes.json();
        const eonetData = await eonetRes.json();

        eventsList.innerHTML = "";

        // Earthquakes
        usgsData.features
          .filter(f=>f.properties.mag>=minmag)
          .forEach(f=>{
            const [lon,lat,depth] = f.geometry.coordinates;
            const mag = f.properties.mag;
            const place = f.properties.place;
            const time = new Date(f.properties.time).toLocaleString();

            const marker = L.circleMarker([lat,lon],{
              radius: Math.max(4, mag*3),
              color: "red",
              fillColor:"orange",
              fillOpacity:0.8
            }).bindPopup(`<b>${place}</b><br>Mag: ${mag}<br>Depth: ${depth} km<br>${time}`);
            marker.addTo(quakesLayer);

            const li=document.createElement("li");
            li.innerHTML=`M${mag} - ${place}`;
            li.onclick=()=>{map.setView([lat,lon],6);marker.openPopup()};
            eventsList.appendChild(li);
          });

        // EONET
        eonetData.events.forEach(ev=>{
          if(ev.geometry && ev.geometry[0].type==="Point"){
            const [lon,lat]=ev.geometry[0].coordinates;
            const title=ev.title;
            const cat=ev.categories[0].title;
            const dt=new Date(ev.geometry[0].date).toLocaleString();

            const marker=L.marker([lat,lon]).bindPopup(`<b>${title}</b><br>${cat}<br>${dt}`);
            marker.addTo(eventsLayer);

            const li=document.createElement("li");
            li.innerHTML=`${title} (${cat})`;
            li.onclick=()=>{map.setView([lat,lon],5);marker.openPopup()};
            eventsList.appendChild(li);
          }
        });

      }catch(err){
        console.error(err);
        eventsList.innerHTML="Error loading data";
      }
    }

    reloadBtn.onclick=loadData;
    timeframeEl.onchange=loadData;
    minmagEl.onchange=loadData;

    themeToggle.onclick=()=>{
      const current=body.getAttribute("data-theme");
      const next=current==="light"?"dark":"light";
      body.setAttribute("data-theme",next);
      themeToggle.textContent=next==="light"?"Dark":"Light";
    };

    loadData();
  </script>
</body>
</html>
